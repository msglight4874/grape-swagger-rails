<!DOCTYPE html>
<html data-swagger-options="<%= GrapeSwaggerRails.options.marshal_dump.to_json %>">
  <head>
    <title><%= GrapeSwaggerRails.options.app_name || 'Swagger UI' %></title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href='//fonts.googleapis.com/css?family=Droid+Sans:400,700' rel='stylesheet' type='text/css'/>
    <%= stylesheet_link_tag 'grape_swagger_rails/application.css' %>
    <%= javascript_include_tag 'grape_swagger_rails/application.js' %>
    <script type="text/javascript">
    $(function () {
      var options = $("html").data('swagger-options');

      var headers = {};
      <% GrapeSwaggerRails.options.headers.each_with_index do |(key, value), index| %>
        <%=raw "headers.header_#{index} = new SwaggerClient.ApiKeyAuthorization('#{CGI.escapeHTML(key)}', '#{CGI.escapeHTML(value)}', 'header');" %>
      <% end %>

      <% if GrapeSwaggerRails.options.api_key_default_value.try(:strip).present? &&
            GrapeSwaggerRails.options.headers['Authorization'].blank? %>
        <% headers_count = GrapeSwaggerRails.options.headers.count %>
        <%= raw "headers.header_#{headers_count} = getApiKeyAuthorization();" %>
      <% end %>

      window.swaggerUi = new SwaggerUi({
        url: options.app_url + options.url,
        dom_id: "swagger-ui-container",
        supportHeaderParams: true,
        supportedSubmitMethods: options.supported_submit_methods || [],
        authorizations: headers,
        onComplete: function(swaggerApi, swaggerUi){
          if('console' in window) {
            console.log("Loaded SwaggerUI")
            console.log(swaggerApi);
            console.log(swaggerUi);
          }
          $('pre code').each(function(i, e) {hljs.highlightBlock(e)});
        },
        onFailure: function(data) {
          if('console' in window) {
            console.log("Unable to Load SwaggerUI");
            console.log(data);
          }
        },
        docExpansion: options.doc_expansion,
        validatorUrl: options.validator_url,
        apisSorter: "alpha"
      });

      <% if GrapeSwaggerRails.options.api_auth == 'hmac' %>
        CustomAuthorization = (function() {
          CustomAuthorization.prototype.username = null;
          CustomAuthorization.prototype.secret = null;

          function CustomAuthorization(username, secret) {
            this.username = username;
            this.secret = secret;
          }

          CustomAuthorization.prototype.apply = function(obj, authorizations) {

            // for debug
            window.obj_inspect = obj;

            var headers = '';
            var signature = '';

            // X-Date: Fri, 13 Oct 2017 07:15:00 GMT
            // header['X-Date'] = 'Fri, 13 Oct 2017 07:15:00 GMT'
            var gmt_date = new Date().toUTCString();
            obj.headers["X-Date"] = gmt_date;
            headers += 'x-date'
            signature += 'x-date: ' + gmt_date;

            // GET /v1/customers HTTP/1.1
            // No header is needed for request-line
            var parser = document.createElement('a');
            parser.href = obj.url;
            headers += ' request-line';
            signature += '\n' + obj.method.toUpperCase() + ' ' + parser.pathname + ' HTTP/1.1';

            // Digest: SHA-256=47DEQpj8HBSa+/TImW+5JCeuQeRkm5NMpJWZG3hSuFU=
            // header['Digest'] if body is given
            var body = obj.body;
            if (body && typeof(body) == 'string') {
              var sha256_base64_body = 'SHA-256=' + CryptoJS.enc.Base64.stringify(CryptoJS.SHA256(body));
              obj.headers["Digest"] = sha256_base64_body;
              headers = headers + ' digest';
              signature += '\ndigest: ' + sha256_base64_body;
            }

            // Authorization: hmac username="rick@testcyb.info@1", algorithm="hmac-sha256", headers="digest", signature="RQmMYvxgBQiaa0AFN9snyOKu+2W6ntV444ICYE7oj1g="
            // header['Authorization']
            var hmac_sha256_base64_signature = CryptoJS.enc.Base64.stringify(CryptoJS.HmacSHA256(signature, this.secret));
            obj.headers["Authorization"] = 'hmac username="' + this.username + '", algorithm="hmac-sha256", headers="' + headers + '", signature="' + hmac_sha256_base64_signature + '"';
          };

          return CustomAuthorization;
        })();
      <% end %>

      function getApiKeyAuthorization() {

        if (options.api_auth == 'hmac') {

          var username = $('#input_username')[0].value;
          var secret = $('#input_secret')[0].value;

          if (username && secret && username.trim() != "" && secret.trim() != "") {
            return new CustomAuthorization(username, secret);
          }

        } else {

          var key = $('#input_apiKey')[0].value;

          if (key && key.trim() != "") {
            if (options.api_auth == 'basic') {
              key = "Basic " + Base64.encode(key);
            } else if (options.api_auth == 'bearer') {
              key = "Bearer " + key;
            } else if (options.api_auth == 'token') {
              key = 'Token token="' + key + '"';
            }
            return new SwaggerClient.ApiKeyAuthorization(options.api_key_name, key, options.api_key_type);
          }
        }
      }

      function addApiKeyAuthorization() {
        var apiKeyAuthorization = getApiKeyAuthorization();
        if (apiKeyAuthorization) {
          window.swaggerUi.api.clientAuthorizations.add("key", apiKeyAuthorization);
        }
      }

      <% if GrapeSwaggerRails.options.api_auth == 'hmac' %>
        $('#input_username').change(addApiKeyAuthorization);
        $('#input_secret').change(addApiKeyAuthorization);
      <% else %>
        $('#input_apiKey').change(addApiKeyAuthorization);
      <% end %>

      window.swaggerUi.load();

    });
    </script>
    <style>
      input#input_baseUrl {
        <% if GrapeSwaggerRails.options.hide_url_input %>
        display: none;
        <% end %>
      }

      input#input_apiKey {
        <% if GrapeSwaggerRails.options.hide_api_key_input %>
        display: none;
        <% end %>
      }

      input#input_username {
        <% if GrapeSwaggerRails.options.hide_api_key_input %>
        display: none;
        <% end %>
      }

      input#input_secret {
        <% if GrapeSwaggerRails.options.hide_api_key_input %>
        display: none;
        <% end %>
      }
    </style>
  </head>

  <body class="swagger-section">
    <div id='header'>
      <div class="swagger-ui-wrap">
        <a id="logo" href="#"><%= GrapeSwaggerRails.options.app_name %></a>
        <form id='api_selector'>
          <div class='input'><input placeholder="http://example.com/api" id="input_baseUrl" name="baseUrl" type="text"/></div>
          <% if GrapeSwaggerRails.options.api_auth == 'hmac' %>
            <div class='input'><input placeholder="Username" id="input_username" name="username" type="text" value=""/></div>
            <div class='input'><input placeholder="Secret" id="input_secret" name="secret" type="text" value=""/></div>
          <% else %>
            <div class='input'><input placeholder="<%= GrapeSwaggerRails.options.api_key_name %>" id="input_apiKey" name="apiKey" type="text" value="<%= GrapeSwaggerRails.options.api_key_default_value %>"/></div>
          <% end %>
          <div class='input'><a id="explore" class="exploreBtn" href="#">Explore</a></div>
        </form>
      </div>
    </div>

    <div id="message-bar" class="swagger-ui-wrap">
      &nbsp;
    </div>

    <div id="swagger-ui-container" class="swagger-ui-wrap"></div>
  </body>
</html>
